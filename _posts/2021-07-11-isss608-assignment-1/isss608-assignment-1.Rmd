---
title: "ISSS608 Assignment 1 Part 1"
description: This post is a submission for ISSS608 Assignment 1, Vast Challenge 2
author:
  - name: Yeo Chia Guan Andy
date: 07-25-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# VAST Challenge 2

# Content

* [1.0 Literature Review]

* [2.0 Insights]
    + [2.1 Credit Card and Loyalty Card Transactions]
        + [2.1.1 Loyalty Card Usage]
        + [2.1.2 Credit Card Usage]
    + [2.2 Visitor per location by day]
        + [2.2.1 Loyalty Card]
        + [2.2.2 Credit Card]
    + [2.3 Total Visits per Store]

* [3.0 Georeferencing]

* [4.0 Inferences]
    + [4.1 Merging Car and GPS Dataset]
    + [# 4.2 Finding Patterns from Patronage and Vehicle Data ]


* [5.0 Future Works]


# 1.0 Literature Review
For the literature review, a sample entry was taken from GitHub on a team who participated in the VAST Challenge 2014, Mini Challenge 2. The team of two was from City University London who performed their analysis using processing and libraries giCentre Utils and geoMap which were written by the giCentre at City University London.

The team used a map to indicate the coordinates of each vehicle at any point in time using animation. Locations outside of the norm were highlighted to find that there were five unknown locations visited by four security employees.

A possible gap to the for this study would be to identify the credit card owners by inferencing the vehicle dataset with the credit card dataset.



```{r}
# Install Required Packages

packages = c('DT','ggiraph','plotly','tidyverse', 'igraph','tidygraph','ggraph', 'sf',
             'visNetwork','lubridate','clock',
             'raster','tmap','clock','st','readr','mapview','ggpubr','greekLetters','widyr','tibble' )


for (p in packages){
  if(!require(p,character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```


```{r}
# Import Data

car <- read_csv("data/car-assignments.csv")
gps <- read_csv("data/gps.csv")
credit_card <- read_csv("data/cc_data.csv")
loyalty <- read_csv("data/loyalty_data.csv")

```


```{r}
#Clean Credit Card and Loyalty Card Data

#Credit card
credit_card$last4ccnum <- as.character(credit_card$last4ccnum)

credit_card$timestamp <- date_time_parse(credit_card$timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y %H:%M")

#Loyalty Card
loyalty$timestamp <- date_time_parse(loyalty$timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y")
```

# 2.0 Insights

## 2.1 Credit Card and Loyalty Card Transactions 

Using the loyalty card and credit card data, we first explore the popularity of shops by counting the number of visits by location.
It was found that Katerina's Cafe and Hippokampos were the top 2 most popular shops in terms of the transactions made over the period from 6 Jan to 19 Jan 2014.


### 2.1.1 Loyalty Card Usage

```{r}
#Loyalty Card usage total represented by Loyalty use variable
loyaltyuse <- loyalty %>%
  group_by(location) %>%
  summarize(timesvisit = length(loyaltynum))

loyaltyuse$location=str_replace_all(loyaltyuse$location,"[^[:graph:]]", " ") 

popular_loyalty <- ggplot(loyaltyuse, aes(y = location, x = timesvisit, color = timesvisit)) + geom_point_interactive(aes(tooltip = timesvisit))

girafe(ggobj = popular_loyalty,width_svg = 6,height_svg = 6*0.618)

```

### 2.1.2 Credit Card Usage

```{r}
#credit Card usage total represented by Loyaltyuse variable
ccuse <- credit_card %>%
  group_by(location) %>%
  summarize(timesvisit = length(last4ccnum))

ccuse$location=str_replace_all(ccuse$location,"[^[:graph:]]", " ") 

popular_cc <- ggplot(ccuse, aes(y = location, x = timesvisit, color = timesvisit)) + geom_point_interactive(aes(tooltip = timesvisit))

girafe(ggobj = popular_cc,width_svg = 6,height_svg = 6*0.618)

```

## 2.2 Visitor per location by day

Next, we next plot the visitor count by day for each location to identify possible trends.
It was also observed that at least 10 vehicles will visit Brew've Been Served every weekday.

On the credit card data, it was noticed that there was 1 visit to the Daily Dealz and 1 visit to U-pump which were out of the normal pattern. The visit to the Daily Dealz was not captured in the loyalty data, hence it can be inferred that the loyalty card might not be applicable for that store.


The data on loyalty card usage collects the date used but not the time, hence it is recommended that the time be collected as well to correctly match the credit card owner and the loyalty card owner to identify the card user.


### 2.2.1 Loyalty Card

```{r}
#Loyalty Card usage by day 
loyaltyday <- loyalty %>%
  group_by(timestamp,location) %>%
  summarize(timesvisit = length(loyaltynum))

loyaltyday$location=str_replace_all(loyaltyday$location,"[^[:graph:]]", " ") 

p <- ggplot(loyaltyday, aes(y = location, x = timestamp, color = timesvisit)) + geom_point_interactive(aes(tooltip = timesvisit))

girafe(ggobj = p,width_svg = 6,height_svg = 6*0.618)

```

### 2.2.2 Credit Card

```{r}
#Credit Card usage by day

#Remove time from timestamp and keep date
credit_card$date <- as_date(credit_card$timestamp)

ccday <- credit_card %>%
  group_by(date,location) %>%
  summarize(timesvisit = length(last4ccnum))


ccday$date <- as.Date(ccday$date)


ccday$location=str_replace_all(ccday$location,"[^[:graph:]]", " ") 

q <- ggplot(ccday, aes(y = location, x = date, color = timesvisit)) + geom_point_interactive(aes(tooltip = timesvisit))
  
girafe(ggobj = q,width_svg = 6,height_svg = 6*0.618)

```


Next we look at merging the credit card data with the loyalty card data to identify their relationship.As the exact transaction time was not recorded for the loyalty card, we draw relationship between the credit card and the loyalty card using the date, location and price variables. 
The left-join method was applied as payment is assumed compulsory by credit card for each transaction while the use of a loyalty card is optional, hence there might be credit card transactions without the use of a loyalty card which was apparent in the chart above as there were more visits recorded for the credit card data when compared to the loyalty card data.
The credit card number should also be consistent with the loyalty card number as both should belong to the same owner.


```{r}
#Left Join Loyalty Card transactions to credit card
patronage <- credit_card %>%
  left_join(loyalty, by = c("date" = "timestamp", "location" = "location", "price" = "price"))

```

```{r}
#Splitting the date time into date, hours and minute
patronage$date <- as_date(patronage$timestamp)
patronage$hour <- hour(patronage$timestamp)
patronage$minute <- minute(patronage$timestamp)



```

```{r}
#ShopTrans will be used to plot the paronage by locations 
ShopTrans <- patronage
ShopTrans$location <- as_factor(ShopTrans$location)
```

```{r}
ShopTrans <- patronage %>%
  #filter(date == "2014-01-07") %>%
  group_by(location) %>%
  summarize(timesvisit = length(last4ccnum))

ShopTrans$location=str_replace_all(ShopTrans$location,"[^[:graph:]]", " ") 

```
The data was grouped by location in which Katerina's Cafe was found the be the most popular location with 214 visitors, followed by Hippokampos with 173 visitors.

This was an anomaly as the credit card data only showed 212 visitors for Katerina's Cafe and 171 for Hippokampos.


## 2.3 Total Visits per Store

```{r}
s <- ggplot(ShopTrans, aes(y = location, x = timesvisit, color = timesvisit)) + geom_point_interactive(aes(tooltip = timesvisit)) #+ facet_grid("hour")
  
girafe(ggobj = s,width_svg = 6,height_svg = 6*0.618)

```

To address the anomaly, we compare the Patronage dataset with the credit card data.
We filter the transactions which were made using a credit card and loyalty card to identify the cause of the anomaly.


In this regard, we found that several credit card transactions had more than 1 loyalty card applied. We see that credit card numbers 1286,4795,4948,5368,5921,7889 and 8332 made transactions with more than 1 loyalty card.

This could imply that there was a meet-up between different employees of GasTech at those locations where a colleague might have used his loyalty card to obtain the benefits from the store.

```{r}
#Identify the credit cards with more than 1 loyalty card

dup <- patronage %>%
  filter(is.na(loyaltynum)==0) %>%
  group_by(last4ccnum,loyaltynum) %>%
  summarise(n = length(unique(loyaltynum)))

dup2 <- dup %>%
  group_by(unique(last4ccnum))%>%
  summarise(UniqueLoyalty = length(loyaltynum))%>%
  filter(UniqueLoyalty>1)
  
dup2
```

Using the interactive datatable, we could identify the transactions made with the above credit card numbers. It was found that the occurrences of using a different loyalty card were more than one.

```{r}
#Insert Interactive Data Table
#Upon joining the data, an attempted was made to create a DT data table using the to explore the dataset. However, an error was found as there were invalid symbols found in the data. 
#To address the issue, greeks() function could be aplied, but the result was the first word for each location. Thus, a regular expression was used to filter out none alphabets.

#patronage$locationgreek <- greeks(patronage$location)
#DT::datatable(patronage)


patronage$location <- str_extract(patronage$location, regex("[:alpha:]*[:space:]*[:alpha:]*"))
DT::datatable(patronage)
```

